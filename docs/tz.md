# Техническое задание: Доработка «Уютный Квартал»

## 1. Общее описание

**Постановка задачи (из README yut-kavrtal):**
- Создание полной рабочей инфраструктуры по продаже студий, апартаментов, офисов и других нежилых помещений
- Главная роль Админа, управляющего данными агентов и настройками через специальную невидимую ссылку
- Публикация объектов с анализом доходности, встроенный калькулятор дохода
- Выбранные объекты публикуются в Telegram-канал с действующими инвесторами

**Цель разработки:** Доработать существующий сайт «Уютный Квартал» до полной инфраструктуры с интеграцией Telegram для публикации объектов.

**Связь с существующей системой:** Проект уже содержит каталог объектов, панель админа, панель агента, калькулятор доходности, аутентификацию. Требуется добавить публикацию в Telegram.

---

## 2. Юзер-кейсы

### UC-01: Публикация объекта в Telegram-канал (новый)

**Актёры:**
- Админ или Агент (авторизованный)
- Система
- Telegram Bot API (внешний)

**Предусловия:**
- Пользователь авторизован (роль admin или agent)
- Настроен Telegram Bot Token в переменных окружения
- Указан ID Telegram-канала для публикации
- Объект существует в каталоге

**Основной сценарий:**
1. Пользователь открывает карточку объекта или панель агента
2. Пользователь нажимает кнопку «Опубликовать в Telegram»
3. Система формирует сообщение: адрес, метро, цена, доходность, ссылка на объект
4. Система отправляет сообщение в настроенный Telegram-канал через Bot API
5. Система отображает уведомление «Объект опубликован»
6. Сообщение появляется в канале с действующими инвесторами

**Альтернативные сценарии:**

**А1: Bot Token не настроен (на шаге 4)**
1. Система логирует ошибку
2. Система отображает: «Публикация в Telegram не настроена. Обратитесь к администратору»
3. Конец

**А2: Ошибка API Telegram (на шаге 4)**
1. Система отображает: «Не удалось опубликовать. Попробуйте позже»
2. Конец

**Постусловия:**
- Сообщение опубликовано в канале (при успехе)
- Пользователь видит результат операции

**Критерии приёмки:**
- ✅ Кнопка «Опубликовать в Telegram» доступна на странице объекта и в панели агента
- ✅ Сообщение содержит: адрес, метро, цена входа, доходность, ссылку
- ✅ При отсутствии BOT_TOKEN кнопка скрыта или показывается сообщение о ненастройке
- ✅ Ошибки API обрабатываются и отображаются пользователю

---

### UC-02: Настройка Telegram в админ-панели (новый)

**Актёры:**
- Админ
- Система

**Предусловия:**
- Пользователь авторизован с ролью admin
- Открыта панель администратора

**Основной сценарий:**
1. Админ открывает раздел «Настройки» или «Telegram» в админ-панели
2. Система отображает форму: Bot Token, Channel ID
3. Админ вводит Bot Token (от @BotFather) и ID канала
4. Админ нажимает «Сохранить»
5. Система сохраняет настройки (env или JSON)
6. Система отображает «Настройки сохранены»

**Альтернативные сценарии:**

**А1: Невалидный Token (на шаге 5)**
1. Система проверяет формат (опционально)
2. При явной ошибке — «Некорректный токен»

**Постусловия:**
- Настройки сохранены
- Публикация в канал возможна

**Критерии приёмки:**
- ✅ Раздел настроек Telegram в админ-панели
- ✅ Поля: Bot Token, Channel ID
- ✅ Значения сохраняются (файл или env)
- ✅ Токен не отображается в UI после сохранения (маскировка)

---

## 3. Нефункциональные требования

- **Безопасность:** Bot Token хранится в переменных окружения или защищённом хранилище, не в коде
- **Совместимость:** Использовать официальный Telegram Bot API (HTTPS)

---

## 4. Ограничения и допущения

- Telegram Bot должен быть добавлен в канал как администратор с правом публикации
- Channel ID — числовой идентификатор канала (например, @channel → -100xxxxxxxxxx)
- Допущение: один канал на всё приложение

---

## 5. Открытые вопросы

- [ ] Формат сообщения в Telegram: только текст или с фото объекта?
- [ ] Нужна ли возможность отложенной публикации?
